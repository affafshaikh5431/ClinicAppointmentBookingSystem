<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Update Patient</title>

    <!-- Bootstrap CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

    <div class="container py-4">

        <!-- Header / Navbar -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary rounded mb-4 p-3">
            <a class="navbar-brand fw-bold" href="#">Clinic Appointment System</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link text-white" href="doctor.html">Doctors</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="Patient.html">Patients</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="Appointment.html">Appointments</a>
                    </li>
                </ul>
            </div>
        </nav>
        <div class="container mt-4">
            <h2 class="mb-3 text-center">Update Patient</h2>

            <div class="card shadow-sm">
                <div class="card-body">

                    <form id="updateForm">
                        <!-- File No (read-only) -->
                        <div class="mb-3">
                            <label class="form-label">File No *</label>
                            <input type="text" id="fileNo" class="form-control" readonly style="background-color: #e9ecef; cursor: not-allowed;">
                        </div>

                        <!-- Name -->
                        <div class="mb-3">
                            <label class="form-label">Full Name *</label>
                            <input type="text" id="name" class="form-control" required>
                        </div>

                        <!-- Phone -->
                        <div class="mb-3">
                            <label class="form-label">Phone</label>
                            <input type="text" id="phone" class="form-control">
                        </div>

                        <!-- Gender -->
                        <div class="mb-3">
                            <label class="form-label">Gender *</label>
                            <select id="gender" class="form-select" required>
                                <option value="">Select</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <!-- Response -->
                        <div id="result"></div>

                        <button type="submit" class="btn btn-primary mt-3 w-100">Update Patient</button>
                    </form>

                    <a href="Patient.html" class="btn btn-secondary mt-3 w-100">Back</a>
                </div>
            </div>
        </div>

        <script>
            const apiBase = "https://localhost:44366/api/patients";

            // Helper to get query string
            function getQueryParam(name) {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(name);
            }

            const fileNo = getQueryParam('fileNo');

            // Fetch existing patient data and populate form
            async function loadPatient() {
                if (!fileNo) return;

                const result = document.getElementById('result');
                result.innerHTML = "Loading patient data...";

                try {
                    const res = await fetch(`${apiBase}/${fileNo}`);
                    if (res.status === 404) {
                        result.innerHTML = `<div class="alert alert-danger">Patient not found</div>`;
                        return;
                    }

                    const patient = await res.json();
                    document.getElementById('fileNo').value = patient.fileNo;
                    document.getElementById('name').value = patient.name;
                    document.getElementById('phone').value = patient.phone;
                    document.getElementById('gender').value = patient.gender;

                    result.innerHTML = "";
                } catch (err) {
                    result.innerHTML = `<div class="alert alert-danger">Error fetching patient</div>`;
                    console.error(err);
                }
            }

            // Update patient
            document.getElementById('updateForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const result = document.getElementById('result');
                const name = document.getElementById('name').value.trim();
                const phone = document.getElementById('phone').value.trim();
                const gender = document.getElementById('gender').value.trim();

                if (!name || !gender) {
                    result.innerHTML = `<div class="alert alert-danger">Name and Gender are required.</div>`;
                    return;
                }

                const patient = { fileNo, name, phone, gender };
                result.innerHTML = "Updating patient...";

                try {
                    const res = await fetch(`${apiBase}/update`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(patient)
                    });

                    const data = await res.text();

                    if (res.ok) {
                        result.innerHTML = `<div class="alert alert-success">Patient updated successfully!</div>`;
                    } else {
                        result.innerHTML = `<div class="alert alert-danger">Error: ${data}</div>`;
                    }
                } catch (err) {
                    result.innerHTML = `<div class="alert alert-danger">Server connection failed</div>`;
                    console.error(err);
                }
            });

            // Load patient on page load
            window.addEventListener('DOMContentLoaded', loadPatient);
        </script>

</body>
</html>
