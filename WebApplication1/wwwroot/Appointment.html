<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>All Appointments</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

    <div class="container py-4">

        <!-- Header / Navbar -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary rounded mb-4 p-3">
            <a class="navbar-brand fw-bold" href="#">Clinic Appointment System</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link text-white" href="doctor.html">Doctors</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="Patient.html">Patients</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="Appointment.html">Appointments</a>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- Add Appointment Button -->
        <div class="text-end mb-3">
            <a href="add_appointment.html" class="btn btn-danger">➕ Book Appointment</a>
        </div>

        <!-- Search by ID -->
        <div class="input-group mb-3">
            <input type="number" id="searchId" class="form-control" placeholder="Enter Appointment ID">
            <button class="btn btn-primary" onclick="searchAppointment()">Search</button>
            <button class="btn btn-secondary" onclick="loadAppointments()">Reset</button>
        </div>

        <!-- Appointments Table -->
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="appointmentsTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Sr.No</th>
                                <th>Patient</th>
                                <th>Doctor</th>
                                <th>Date & Time</th>
                                <th>Duration (min)</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        const apiBase = "https://localhost:44366/api";

        
        async function loadAppointments() {
            document.getElementById("searchId").value = "";
            const tableBody = document.querySelector('#appointmentsTable tbody');
            tableBody.innerHTML = `<tr><td colspan="7">Loading...</td></tr>`;

            try {
                const res = await fetch(`${apiBase}/appointments`);
                const appointments = await res.json();

                if (!appointments || appointments.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="7">No appointments found</td></tr>`;
                    return;
                }

                tableBody.innerHTML = "";
                let srNo = 1;
                appointments.forEach(a => {
                    const dateTime = a.appointmentDateTime ? new Date(a.appointmentDateTime) : null;
                    tableBody.innerHTML += `
                            <tr>
                                <td>${srNo++}</td>
                                <td>${a.patientName || "N/A"}</td>
                                <td>${a.doctorName || "N/A"}</td>
                                <td>${dateTime ? dateTime.toLocaleString() : "N/A"}</td>
                                <td>${a.durationInMinutes || 30}</td>
                                <td>${a.status || "Scheduled"}</td>
                                <td>
                                ${a.status && a.status.toLowerCase() === "cancelled"
                                ? `<span class="badge bg-secondary">Already Cancelled</span>`
                                : `<button class="btn btn-sm btn-danger" onclick="cancelAppointment(${a.appointmentId})">
                                               Cancel Appointment
                                           </button>`
                                }
                            </td>
                            </tr>
                        `;
                });

            } catch (err) {
                console.error(err);
                tableBody.innerHTML = `<tr><td colspan="7">Error loading data</td></tr>`;
            }
        }

        async function cancelAppointment(id) {
            if (!confirm("Are you sure you want to cancel this appointment?")) return;

            try {
                const res = await fetch(`${apiBase}/appointments/cancel/${id}`, {
                    method: "PUT"
                });

                if (res.ok) {
                    alert("Appointment Cancelled Successfully");
                    loadAppointments();
                } else {
                    const err = await res.json();
                    alert(err.message || "Failed to cancel");
                }
            } catch (e) {
                alert("Server error while canceling appointment");
            }
        }

        // Search Appointment by ID
        async function searchAppointment() {
            const id = document.getElementById("searchId").value.trim();
            const tableBody = document.querySelector('#appointmentsTable tbody');

            if (!id) {
                alert("Please enter Appointment ID!");
                return;
            }

            tableBody.innerHTML = `<tr><td colspan="7">Searching...</td></tr>`;

            try {
                const res = await fetch(`${apiBase}/appointments/${id}`);
                if (!res.ok) throw new Error("Not found");

                const a = await res.json();
                const dateTime = new Date(a.appointmentDateTime);

                tableBody.innerHTML = `
                        <tr>
                            <td>1</td>
                            <td>${a.patientName || "N/A"}</td>
                            <td>${a.doctorName || "N/A"}</td>
                            <td>${dateTime.toLocaleString()}</td>
                            <td>${a.durationInMinutes}</td>
                            <td>${a.status}</td>
                            <td>
                                ${a.status && a.status.toLowerCase() === "cancelled"
                                                    ? `<span class="badge bg-secondary">Already Cancelled</span>`
                                                    : `<button class="btn btn-sm btn-danger" onclick="cancelAppointment(${a.appointmentId})">
                                           Cancel Appointment
                                       </button>`
                                }
                            </td>

                        </tr>
                    `;
            } catch {
                tableBody.innerHTML = `<tr><td colspan="7">No record found for ID: ${id}</td></tr>`;
            }
        }

        window.addEventListener("DOMContentLoaded", loadAppointments);
    </script>

</body>
</html>
